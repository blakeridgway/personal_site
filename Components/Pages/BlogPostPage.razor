@page "/blog/{Slug}"
@using PersonalSite.Models
@using PersonalSite.Services
@inject IBlogService BlogService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable

<!-- Reading Progress Bar -->
<div class="reading-progress-bar" id="readingProgressBar"></div>

@if (_post == null)
{
    <PageTitle>Loading... | Blake Ridgway</PageTitle>
    <div class="container-lg py-5 text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (_notFound)
{
    <PageTitle>Not Found | Blake Ridgway</PageTitle>
    <div class="container-lg py-5 text-center">
        <div class="card-glass rounded-4 p-5">
            <i class="bi bi-exclamation-triangle fs-1 text-warning mb-3"></i>
            <h1 class="h3 mb-3">Article Not Found</h1>
            <p class="text-muted mb-4">The article you're looking for doesn't exist or has been moved.</p>
            <a href="/blog" class="btn btn-primary">
                <i class="bi bi-arrow-left me-2"></i>Back to Blog
            </a>
        </div>
    </div>
}
else
{
    <PageTitle>@_post.Title | Blake Ridgway</PageTitle>
    <HeadContent>
        <meta property="og:title" content="@_post.Title" />
        <meta property="og:description" content="@_post.Excerpt" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="/blog/@_post.Slug" />
        <meta property="og:site_name" content="Blake Ridgway" />
        <meta property="article:published_time" content="@_post.PublishedDate.ToString("yyyy-MM-ddTHH:mm:ssZ")" />
        <meta property="article:author" content="@_post.Author" />
        @foreach (var tag in _post.Tags)
        {
            <meta property="article:tag" content="@tag" />
        }
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:title" content="@_post.Title" />
        <meta name="twitter:description" content="@_post.Excerpt" />
    </HeadContent>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container-lg position-relative">
            <div class="row align-items-center">
                <div class="col-lg-10">
                    <a href="/blog" class="btn btn-ghost mb-4">
                        <i class="bi bi-arrow-left me-2"></i>Back to Blog
                    </a>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <span class="blog-card-category @GetCategoryClass(_post.Category)">@_post.Category</span>
                    </div>
                    <h1 class="display-hero mb-4">@_post.Title</h1>
                    <div class="d-flex flex-wrap gap-4 text-muted">
                        <span><i class="bi bi-person me-2"></i>@_post.Author</span>
                        <span><i class="bi bi-calendar3 me-2"></i>@_post.PublishedDate.ToString("MMMM d, yyyy")</span>
                        <span><i class="bi bi-clock me-2"></i>@_post.ReadTime min read</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container-lg py-5">
        <div class="row g-5">
            <div class="col-lg-8">
                <article class="card-glass rounded-4 p-5">
                    <div class="blog-content">
                        @((MarkupString)_post.HtmlContent)
                    </div>

                    @if (_post.Tags.Any())
                    {
                        <div class="post-tags mt-5 pt-4 border-top border-dark-subtle">
                            <h4 class="h6 mb-3">Tags</h4>
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var tag in _post.Tags)
                                {
                                    <span class="badge-stack">@tag</span>
                                }
                            </div>
                        </div>
                    }
                </article>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="card-glass rounded-4 p-4 sticky-top" style="top: 80px;">
                    <h3 class="h6 mb-3">
                        <i class="bi bi-info-circle text-primary me-2"></i>About the Author
                    </h3>
                    <p class="small text-muted mb-3">
                        Blake Ridgway is a Site Reliability Engineer focused on building resilient,
                        observable cloud infrastructure at scale.
                    </p>
                    <div class="d-flex gap-2">
                        <a href="https://github.com/blakeridgway" class="social-icon" target="_blank">
                            <i class="bi bi-github"></i>
                        </a>
                        <a href="https://linkedin.com/in/blakearidgway" class="social-icon" target="_blank">
                            <i class="bi bi-linkedin"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string Slug { get; set; } = string.Empty;

    private BlogPost? _post;
    private bool _notFound;
    private bool _progressInitialized;

    protected override async Task OnParametersSetAsync()
    {
        _post = await BlogService.GetPostBySlugAsync(Slug);
        _notFound = _post == null;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_post != null && !_progressInitialized)
        {
            _progressInitialized = true;
            await JSRuntime.InvokeVoidAsync("initReadingProgress");
        }
    }

    public void Dispose()
    {
        _ = JSRuntime.InvokeVoidAsync("disposeReadingProgress");
    }

    private string GetCategoryClass(string category)
    {
        return category?.ToLower() switch
        {
            "tech" or "technology" or "infrastructure" or "devops" or "sre" => "tech",
            "cycling" or "biking" or "endurance" => "cycling",
            _ => "general"
        };
    }
}
